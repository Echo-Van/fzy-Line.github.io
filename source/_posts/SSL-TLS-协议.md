---
title: SSL/TLS 协议
tags:
  - 安全
categories:
  - Network
abbrlink: 37171
date: 2019-12-01 21:02:38
---

<center>图解密码技术学习笔记-SSL/TLS协议</center>
<!--more-->

#### SSL/TLS 概念

　　SSL/TLS 协议位于网络 OSI 七层模型的会话层，用来加密通信。SSL（Secure Sockets Layer，安全套接字层）是一种标准安全协议，用于在在线通信中建立Web服务器和浏览器之间的加密链接。SSL 通过互相认证、使用数字签名确保完整性、使用加密确保私密性，以实现客户端和服务器之间的安全通讯。

　　TLS（Transport Layer Security，传输层安全）是 IETF 在 SSL 3.0 的基础上设计的协议，它是 SSL 协议的升级版。两者差别极小，可以理解为 TLS 是 SSL 3.1。

#### TLS 协议结构

　　TLS 协议分成两层：TLS 记录协议（TLS record protocol）、TLS 握手协议（TLS handshake protocol）

![1-1](https://fzy-blog.oss-cn-shenzhen.aliyuncs.com/2019/12/1-1.png)

　　TLS 握手协议负责加密以外的其他事情。握手协议分成 4 个子协议，分别是：
- **握手协议**：负责通信双方之间协商决定密码算法和共享密钥
- **密码规格变更协议**：负责向通信对象传达变更密码方式的信号
- **警告协议**：负责在发生错误时将错误传给对方
- **应用数据协议**：是将TLS承载的应用数据传达给通讯对象

　　TLS 记录协议负责消息的压缩、加密以及数据的认证。TLS 记录协议使用到的所有的算法等都是经过握手协议协商确认后的，以保证通讯双方是使用相同的算法。处理过程：
- 首先，消息会被分割成多份，并用协商好的压缩算法进行压缩。
- 其次，压缩片段会加上消息认证码以保证完整性，为了防止重放攻击还加上了片段编号。
- 再次，压缩后的消息片段会加上消息认证码一起进行加密。加密使用 CBC 模式，初始向量是通过主密码生成。
- 最后，加密后的报文，再加上数据类型、版本号、压缩后的长度组成的报头，就是最终的数据报文。

#### 握手过程

![1-2](https://fzy-blog.oss-cn-shenzhen.aliyuncs.com/2019/12/1-2.png)

1. **ClientHello（客户端 -> 服务器）**
- 客户端向服务端发送自己的信息：可用的版本号、当前时间、客户端随机数、会话ID、可用的密码套件清单、可用的压缩方式清单。
- 可用的版本号、可用的密码套件清单、可用的压缩方式清单：因为不同的浏览器可能支持的情况不一样，所以需要发送给服务端以方便协商。
- 当前时间：TLS不使用，但是上层的协议有可能使用。
- 客户端随机数：后面会使用到。
- 会话ID：客户端和服务端需要重新使用之前的连接时，会使用到此信息。

2. **ServerHello（服务器 -> 客户端）**
- 服务端向客户端发送自己的信息：使用的版本号、当前时间、服务器随机数、会话ID、使用的密码套件清单、使用的压缩方式清单
- 使用的版本号、使用的密码套件清单、使用的压缩方式清单：这里发送的就是协商后的确定结果
- 当前时间：TLS不使用，但是上层的协议有可能使用
- 服务器随机数：后面会使用到

3. **Certificate（服务器 -> 客户端）**
- 发送服务器的证书，包含证书清单，客户端会对其进行验证。如果是匿名通信，则不发送该消息。
- 如果 Certificate 不足以满足需求时，则会发送 ServerKeyExchange （服务器 -> 客户端）消息。具体的内容根据密码套件的不同而有所不同。这个不是必须的。
- 双向认证，服务器则会发送 CertificateRquest（服务器 -> 客户端）找客户端要其证书用来验证。这个也不是必须的。

4. **ServerHelloDone（服务器 -> 客户端）**
- 通知客户端 Hello 时间结束。
- 如果服务器要了客户端的证书，则客户端发送 Certificate（客户端 -> 服务器）将其证书发送给服务器。

5. **ClientKeyExchange（客户端 -> 服务器）**
- 这个就是最关键的一步，交换生成最终密钥的关键素材。
- 如果是使用的 RSA，则会将经过服务器公钥加密的预备主密码随着 ClientKeyExchange 消息一起发送。
- 如果是 Diffie-Hellman 密钥交换，则随着 ClientKeyExchange 消息一起发送的是 Diffie-Hellman 公开值。
- 预备主密码使得服务端和客户端分别计算出相同的主密码。
- 如果服务器向客户端发送了消息，客户端还会向服务器发送 CertificateVerify（客户端 -> 服务器）消息，这是为了向服务器证明，自己确实是真实的客户端，拥有客户端证书的私钥。为了实现这个目的，客户端会计算主密码和握手协议种传送的消息的散列值加上自己的数字签名后发送给服务器。

6. **生成密钥**
- 根据关键的密钥素材主密码生成：对称密码的密钥、消息认证码的密钥、对称密码的CBC模式中使用的初始化向量

7. **ChangeCipherSpec（客户端 -> 服务器）和 Finished（客户端 -> 服务器）**
- **ChangeCipherSpec**
  - 这不是握手协议，而是密码规格变更协议。客户端告诉服务器我要换密码了。
  - 因为已经双方已经交换了密码套件信息，可以开始切换密码进行通信了。
- **Finished**
  - 代表客户端已经搞定了

7. **ChangeCipherSpec（服务器 -> 客户端）**和 **Finished（服务器 -> 客户端）**
- **ChangeCipherSpec**
  - 服务器告诉客户端，我要开始换密码了
- **Finished**
  - 代表服务器已经搞定了

　　接下来，就可以切换到安全的应用数据交换。

#### 主密码
- 主密码是根据下面信息计算出来的：预备主密码、客户端随机数、服务器随机数。
- 如果是 RSA，在握手的时候客户端就会把预备主密码发送给服务器；如果是 Diffie-Hellman，则会发送公开值给服务器，然后客户端和服务器根据这个值生成预备主密码。
- 客户端随机数和服务器随机数相当于为了防止攻击者事先计算出来的盐值。
- 使用主密码生成对称密码的密钥、消息认证码的密钥、对称密码的CBC模式中使用的初始化向量。